---
// src/components/ThemeToggler.astro
---

<div class="theme-dropdown">
  <button class="dropdown-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
    <span class="theme-icon-placeholder"></span>
  </button>
  <ul class="dropdown-menu">
    <li><button data-theme-value="light"><span class="icon">â˜€ï¸</span> æ˜äº®</button></li>
    <li><button data-theme-value="dark"><span class="icon">ğŸŒ™</span> é»‘æš—</button></li>
    <li><button data-theme-value="auto"><span class="icon">ğŸ–¥ï¸</span> è‡ªåŠ¨</button></li>
  </ul>
</div>

<script>
  type ThemePreference = 'light' | 'dark' | 'auto';

  const LS_THEME_KEY = 'theme-preference';

  const dropdown = document.querySelector('.theme-dropdown');
  const toggleButton = dropdown?.querySelector('.dropdown-toggle'); // ä½¿ç”¨å¯é€‰é“¾å¢å¼ºå¥å£®æ€§
  const iconPlaceholder = toggleButton?.querySelector('.theme-icon-placeholder');
  const themeOptions = dropdown?.querySelectorAll<HTMLButtonElement>('.dropdown-menu button');

  // ========================================================================
  // æ–°å¢çš„â€œç©ºå€¼å®ˆå«â€ï¼šæ£€æŸ¥æ ¸å¿ƒå…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åœæ­¢è„šæœ¬æ‰§è¡Œ
  // ========================================================================
  if (!dropdown || !toggleButton || !iconPlaceholder || !themeOptions) {
    // æ‰“å°ä¸€ä¸ªé”™è¯¯ä¿¡æ¯æ–¹ä¾¿è°ƒè¯•ï¼Œç„¶åé€€å‡º
    console.error('Theme Toggler elements not found. Script will not run.');
  } else {
    // åªæœ‰å½“æ‰€æœ‰å…ƒç´ éƒ½å­˜åœ¨æ—¶ï¼Œæ‰æ‰§è¡Œä¸‹é¢çš„æ‰€æœ‰é€»è¾‘
    const ICONS: Record<ThemePreference, string> = {
      light: 'â˜€ï¸',
      dark: 'ğŸŒ™',
      auto: 'ğŸ–¥ï¸',
    };

    const applyPreference = (preference: ThemePreference) => {
      let theme = preference;
      if (preference === 'auto') {
          theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }

      if (theme === 'dark') {
          document.documentElement.classList.add('dark');
      } else {
          document.documentElement.classList.remove('dark');
      }

      // æ›´æ–°æŒ‰é’®å›¾æ ‡çš„é€»è¾‘ä¿æŒä¸å˜
      updateToggleButtonIcon(preference);
  };

    const updateToggleButtonIcon = (preference: ThemePreference) => {
      iconPlaceholder.textContent = ICONS[preference];
    };

    const savedPreference = localStorage.getItem(LS_THEME_KEY) as ThemePreference || 'auto';
    applyPreference(savedPreference);

    themeOptions.forEach(button => {
      button.addEventListener('click', (e) => {
        const newPreference = button.dataset.themeValue as ThemePreference;
        localStorage.setItem(LS_THEME_KEY, newPreference);
        applyPreference(newPreference);
        dropdown.classList.remove('open');
        e.stopPropagation();
      });
    });

    toggleButton.addEventListener('click', (e) => {
      dropdown.classList.toggle('open');
      e.stopPropagation();
    });

    document.addEventListener('click', () => {
      if (dropdown.classList.contains('open')) {
        dropdown.classList.remove('open');
      }
    });

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      const currentPreference = localStorage.getItem(LS_THEME_KEY) as ThemePreference;
      if (currentPreference === 'auto' || !currentPreference) {
        applyPreference('auto');
      }
    });
  }
</script>

<style>
  /* æ ·å¼ä¿æŒä¸å˜ */
  .theme-dropdown {
    position: relative;
    display: inline-block;
  }
  .dropdown-toggle {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.5rem;
    padding: 0.5em;
    line-height: 1;
    border-radius: 8px;
    transition: background-color 0.2s ease;

    /* --- æ–°å¢ï¼šå›ºå®šå°ºå¯¸æ¥é˜²æ­¢å¸ƒå±€ç§»åŠ¨ --- */
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px; /* ç»™ä¸€ä¸ªå›ºå®šçš„å®½åº¦ */
    height: 40px; /* ç»™ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ */
    /* --- æ–°å¢ç»“æŸ --- */
  }

  .dropdown-toggle:hover {
    background-color: var(--code-bg-color);
  }
  .dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin: 0.5rem 0 0;
    padding: 0.5rem;
    list-style: none;
    background-color: var(--html-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: var(--box-shadow);
    z-index: 30;
    min-width: 120px;
    visibility: hidden;
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
  }
  .theme-dropdown.open .dropdown-menu {
    visibility: visible;
    opacity: 1;
    transform: translateY(0);
  }
  .dropdown-menu li {
    width: 100%;
  }
  .dropdown-menu button {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.5rem 0.75rem;
    background: none;
    border: none;
    text-align: left;
    cursor: pointer;
    border-radius: 6px;
    font-size: 1rem;
    color: var(--font-color);
    transition: background-color 0.2s ease;
  }
  .dropdown-menu button:hover {
    background-color: var(--code-bg-color);
  }
  .dropdown-menu .icon {
    font-size: 1.25rem;
  }
</style>